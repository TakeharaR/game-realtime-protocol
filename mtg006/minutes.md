ゲームリアルタイム通信プロトコル 第六回会合
===
当資料は 『ゲームリアルタイム通信プロトコル 第六回会合』 の議事録です。


# CEDEC 2025 "ゲームにおけるリアルタイム通信へのQUIC導入事例の紹介" 登壇者への質問大会

資料 → [ゲームにおけるリアルタイム通信へのQUIC導入事例の紹介](https://speakerdeck.com/segadevtech/cedec-2025-gemuniokeruriarutaimutong-xin-heno-quicdao-ru-shi-li-noshao-jie)

### 観点

- QUIC をそのままゲームのリアルタイム通信に適用する方向で進めるのが良いのかどうか
- 足りないものは何か
- 逆に良かった点は何か

### 補足

今回度々話題にあがっている"シーケンシャル"という言葉については、順序通りにデータを送信したいという意味合いというよりは、逐次的にパケットを送信したい、という意味合いで用いられている。
→ データ送信の即時性を求め、帯域幅を優先するのではなく、なるべく RTT を短いしたい


### (おさらい) QUIC を使ってシーケンシャルなやり取りをどう担保したか

ゲームのリアルタイム通信ではバイトストリームよりシーケンシャルな通信も多いがそれを QUIC でどう実現したか。

- Sphingo
    - Sphingo は元々社内にあった TCP, UDP, SCTP 実装のネットワークライブラリに QUIC を追加した形
        - UDP には信頼性を持たせる拡張をしている
    - ゲームなのでシーケンシャルにデータを送りたいケースの方が多いのは確か
    - 元々 TCP でシングルストリーム内にマルチチャネルの実装をしていたので QUIC でもその MUX/DEMUX を応用した
    - エフェクトやらゲームと関係ない広告のようなシーケンシャルにする必要がないデータは別のストリームで通信したりする
        - こうした箇所で QUIC がマルチストリームなのは有利に働く面もある
- Nemofiller (Sonic Rumble)
    - Sphingo と同様


### QUIC のゲームへの適用

- QUIC は元々の思想が Web ベース寄り(ストリーム的な思想)なのでゲームのシーケンシャルなゲームの通信部とは相性が悪い側面がある
    - 帯域幅ベースの思想で、余ってるから送らない、余っているから埋めてみたがそこが分割されてしまう等は避けたい
    - 元々の QUIC の思想を壊さずにどれだけゲームの要求にあわせた実装にできるかどうかが今後のポイントになる
        - そういった制御ができるオプションも欲しい
- 当会の活動でも、まずは QUIC をゲームに採用してみて、その上で足りない所を洗い出して、必要であればゲーム用のプロトコルを提案する、というのを考えている
    - 各々でコアは似たような、それでいて細部だけ異なるような実装をするのは効率が悪い


### UDP の疎通について

※補足※
Sonic Rumble の TCP へのフォールバック発生率は 0.014% (CEDEC 2025 発表資料より)

- UDP が疎通するかどうかは地域依存・端末依存はなく施設依存な印象
    - 病院や学校や企業内環境では通らないこともある
        - とは言え、こういうシチュエーションでは施設の Wi-Fi ではなく自前の回線でプレイして貰える土壌は整ってきてはいる
    - 開発者の環境が一番疎通性が悪い、ということもありえる
    - (セガ以外の会社の複数人からの意見) 同様の印象がある
- TCP へのフォールバック
    - もはや不要なのではないか
        - 実際にフォールバックしていない会社もある
        - CEDEC 2025 のアンケートでもしていない人が結構居た
    - 公平性やプレイ感の観点からもフォールバックするかしないかを判断する
    - 老人ホーム向け等、特殊な環境へのサービスを考慮してフォールバックを残す手は
- 元々 Sonic Rumble でフォールバックを用意したのは UDP が疎通しない地域があるという噂があったから
    - 噂に惑わされないためにも UDP がブロックされている環境はほとんどなくなっている、という情報を発信していくのが大事
    - 実際に UDP の疎通に関する大規模な検証結果が少ないのは業界として改善した方が良い
        - ほぼ唯一の大規模なデータである [Google の QUIC の論文](https://asnokaze.hatenablog.com/entry/2017/08/13/022447)は 2016 のもので、その際ではまだ 4% も疎通していなかった
- P2P の疎通性については「ゲームNW接続性WG」で取り扱っているので気になる方はそちらで


### 無線環境について

- Sonic Rumble のデータについて、有線か無線かは区別していない
    - 対戦格闘ゲームや FPS 等では画面上に表示していることはある
- Sonic Rumble は PC 版があるが、ユーザ数的にはほとんどスマホ版
    - PC 版が少ないというよりはスマホ版が多い
- 最近は家庭内でも無線環境は非常に多い
    - 家庭内の無線環境は劣悪なことも多い
    - そういった意味でも QUIC 採用の価値はある
- IP アドレスが変わる問題
    - エリア間の NAT 方式が異なる際等で変わることがあり、そういった際のトラブルは追い辛い
        - 最近は改善されているが、昔は山手線をグルグルまわっているだけで IP アドレスが変わっていたのでそれでテストをしたりしていた
    - Native IPv6 を使えばいいがそれはそれで問題が色々ある


### Connection-Migration

- 切り替わりの検出
    - Winsock の場合は NDIS (Network Driver Interface Specification) がこっそり吸収していることがあり、気づかないが IP アドレスが変わっている、だが接続は維持されたまま、というようなことがありやり辛い
        - コールバックのようなものもない
        - この挙動は P2P 等でも問題になりがち
        - 事例
            - UDP で bind していてもエラーが出ずにそのまま続けられてしまう……
            - port 変わっているがなぜか通信が継続されている……
        - マルチパスの話が進むと今後より複雑になり大変になりそう
- Connection-Migration で結局何も楽にならなかった？
    - 仕様面としてはここまでが限界であとは恐らく実装上の話
    - 大変なのは分かっていたが想像より更に大変だった、というのも事実
    - Connection-Migration の為だけに QUIC にするのはお勧めしない、ということではなく、仕様があること自体は大きい
        - 自前でやる場合も仕様は別途策定しなければならない
        - サーバサイド側の対応も自前になる
        - 仕様はあるので実装さえできれば良い
    - NAT 等の論理面も入ってくるのでテスト環境を用意するのも非常に大変
        - 仮想環境は用意できるがそれで完全な確認とできるかというとそうではないのも一因
        - タイミング等が環境依存だったりするので実環境の情報が重要


### 今後 QUIC の改善を行っていくか、独自プロトコルを作っていくか

- Sphingo
    - 今後独自拡張のプロトコルはシュリンクしていく方針
    - 若手の学習等今後の保守も踏まえると、標準に乗っかっておく価値が大きい
        - 自前実装は標準から外れてしまう面がどうしても出るので、そこのラーニングやメンテナンスコストがどうしても掛かってしまう
- Nemofiller (Sonic Rumble)
    - そもそも RUDP 実装したくなかったから QUIC を採用したが結局 RUDP も実装したので QUIC を採用した意味が薄まってしまった所はある
        - QUIC の実装は大変なので OSS を採用したがその OSS のビルド環境やラッパライブラリの保守が非常に大変だった
    - QUIC 自体は良いもの
        - C# の OSS があればこの辺りの問題が解消されるので QUIC 採用の価値が高まる
- QUIC の採用について
    - QUIC の実装は Rust なものが多いが、マルチプラットフォーム対応的には Rust のものは採用が難しいのも QUIC を採用し辛いポイント
        - C/C++ の QUIC 実装は少な目(ないわけではない)
    - 各種プラットフォーマーさんと協調していく必要がある


### Sonic Rumble 実測値について

※補足※
環境や実測結果は CEDEC 2025 発表資料参照

- ユーザ環境での UDP との比較結果が知りたい
    - 検証時には UDP と QUIC で差がないが TCP と差が顕著に出ている
    - ユーザ環境では UDP と QUIC にも恐らく差があるはず
        - パケロスが多い環境や輻輳が起こっているような環境
    - QUIC の効果を測るには QUIC とそれ以外のプロトコルの比較結果を継続的に知りたいが、運用中のタイトルでこれを行うのは非常に難しい
        - しかし、 QUIC の採用を増やすにはこうした説得力のあるデータが必要
        - 実際のタイトルで QUIC とそれ以外をユーザに知らせずに勝手に切り替えて計測するようなことはできない
            - 公平性の問題
            - 開発・保守面も厳しい
            - 片方だけで問題が起こったら……
    - 実現の為のアイデア
        - 当会でサンプルサプリを作成して計測する？
            - 開発・保守コストやサーバの運用費用の問題がある
        - ユーザが選べるようにしてみる
            - QUIC かそれ以外のプロトコルが早いかは実際の所環境依存な面もあるので、調子が悪い場合はプロトコルを切り替えてみてください、というような形でユーザにやってもらうのはありかも
- MTU 超えるサイズの結果は？
    - Sonic Rumble では Nemofiller が MTU 超えないような実装になっているので不明
    - QUIC の場合は最小のパケットサイズの推奨値(1,200)もある
        - PMTUD により増加可能


### その他の話題

- QUIC の暗号化のコスト
    - クライアントは気にならないがサーバサイドへの影響はある
- QUIC Datagram の ACK 問題
    - サーバ費用にも影響が出る
    - ACK の制御についても別途 IETF で議論が進んではいるが、そこにゲーム会社はほとんど絡んでいない
        - ゲーム向けの拡張や仕様についても業界でもっと話し合って標準側に提案すべき
        - ゲームのネットワーク技術はクローズドな傾向にあるのも問題
            - ゲーム毎に仕様や要求が異なり過ぎるのも要因としてありそうだがそのままは
- iOS, Android のネイティブの通信 API について
    - どうせマルチプラットフォーム対応をしないといけないので採用するようなことはほぼない
    - C1 系のモデム採用機種はプラットフォーム API を優先するような噂がある
        - iPhone 17 Air が C1 なのでそろそろ対応しないといけないかも？


### Is QUIC the best choice?

本日の議論結果と進行中の「ゲームのリアルタイム通信に必要な要素の整理」をまとめて QUIC との対応表を作るのが良さそう(運営課題)。

- UDP ベース (フォールバック)
- QUIC Datagram 以外の細かい設定・拡張
- 暗号化必須
- Connection-Migration
- 制御アルゴリズム関連
    - QUIC に紐づく部分と紐づかない部分がある
- エコシステム
- etc…



# ゲーム業界におけるリアルタイム通信プロトコルの最適な選択肢を探るラウンドテーブル 2025 振り返り

- 所感
    - 議論への参加人数は相変わらず少な目
    - 議論内容自体は 2023 よりは踏み込めた感触はある
- 課題
    - 議論時間が足りない
        - 次回はもう少しテーマを絞って実施したい
    - 当会への参加者とそうでない方での前提の差を感じた
        - 事前の説明をもう少し厚くする
- 盛り上げる為の施策
    - もう少し参加者に向けて色々アンケートを実施しても良さそう
- 参加者を増やす施策
    - この会のラウンドテーブルがどのようなものかもう少し啓蒙をした方が良さそう
        - 日本人はラウンドテーブルに対して敷居の高さを感じる人が多い
            - 開始前に部屋の前で迷っているような人も居た
    - 単に聞きに来たい人も多いので、聞き専用のスペース用意は継続したい
        - GDC のラウンドテーブル等だと参加前提だが、当会の場合は入り口はそれでも良いのでそこから繰り返すことにより議論に参加してくれれば良い
    - 初心者向けのネットワーク講演をして、そこからの導線を作るのもありかもしれない
        - CEDEC 全体としてアドバンスドな話が多いのはある
            - 続きものの講演もちらほらある


# 技術書典 19 について

- 業界貢献・情報発信の一環として技術同人誌を書いてみよう、という流れになっている
- 建付け
    - ゲームの(リアルタイム)ネットワークに関する合同誌
    - 技術書典毎に新刊を出せれば出す
    - 原稿落とした場合は次の合同誌に記載することで書き途中でも無駄にならないようにする
- 内容
    - ゲームのネットワークに絡む内容ならなんでも OK
        - できるだけリアルタイム寄りの内容にしたいところ
    - ページ数や形式の縛りも無し
        - 対談や対話形式等何でも OK
- ネタ候補
    - ゲーム業界におけるネットワークエンジニアのお仕事紹介
        - サーバサイド以外のゲーム業界のネットワークの仕事についてイメージを持てない学生が多そう
    - 通信対戦ゲームにおける小数点の取り扱いについて 
    - 浮動小数点誤差とか
    - P2P 通信の基礎
    - 通信データの設計思想の話
    - その他ゲームならではの工夫
        - [セガ節政氏、オンラインゲームの実装テクニックをレクチャー「バーチャファイター」から「PSU」まで、ネットワークプログラムの実例を紹介以来あまりこの手の話がなかったので](https://game.watch.impress.co.jp/docs/news/391007.html) の最新版の話
    - ネットワーク上で遅延やジッタが発生するメカニズムの解説
    - リアルタイム通信系の用語まとめ
        - どちらかと言えば GitHub のような公開場所でやった方が良さそう
    - トラブル事例集
    - 今までの議論を整理して公開
- 質疑
    - 基礎の場合どこまで書けばいい？
        - 技術同人誌自体が一回で終わる話でないので記事も一回で全て書く必要はない
        - P2P 通信の基礎 1-10 とかでも OK
    - ターゲットは？
        - 学生・初心者


# Slack 話題からの抜粋

### eSIM の検証コストについて

- iPhone 17 が eSIM オンリーに舵をきったのを皮切りに今後 eSIM オンリー端末が増えるとモバイルブロードバンドの検証コストが今後跳ね上がりそう
    - Air は全世界で eSIM オンリー
    - 無印や Pro は一部の地域で物理 SIM モデルがある
- これまでは物理 SIM を使いまわして色々な端末の検証をしていたがそれができなくなる
- どこかが SIM のサブスクサービスを開業してくれると良いが……
    - 全キャリアの SIM が使えるようなサブスクは厳しそう
        - 各社で一つあればそれで運用上は問題なさそう
    - そもそも MDM で SIM の転送が現状できなさそう
        - となると、まずは MDM に SIM の機能を入れる必要があるが、そのコントロールレイヤーをキャリアが公開するかというと厳しそう
    - 総務省やネットワーク系の会社に働きかける必要がある
    - サブスクのようなものができたとしても普及には時間が掛かるだろう
        - 過渡期は対応していない端末は物理等になりコストが上がるのは避けられない
- eSIM の普及が鍵にはなる
    - 引き続き注視していく


### L4S

- L4S 補足メモ(CEDEC 2025 RT で話せなかったネタ)
    - [RFC 9330 - Low Latency, Low Loss, and Scalable Throughput (L4S) Internet Service: Architecture](https://datatracker.ietf.org/doc/rfc9330/)
    - [【T‑Mobile Is First to Unlock L4S in Wireless — A Key Step Toward a Smarter, Programmable 5G】](https://www.t-mobile.com/news/network/unlock-l4s-5g-advanced) 
    - [IIJ様の資料がとても分かり易い]
        - [TechTrend Talk Series vol.11 L4Sで低遅延インターネットは実現できるか？ IIJ技術研究所 長 健二朗](https://seminar-materials.iijlab.net/iijlab-seminar/iijlab-seminar-20240528.pdf)
    - Comcast(米ケーブルテレビ)でもサービス開始している
        - [What is Latency?](https://corporate.comcast.com/stories/latency-speed-explainer)
- ゲームのレイヤーではやる必要があることはほとんどなく遅延が改善される可能性がある
    - ソフトウェア的なものではあるが中継器やルータ等側で対応されるもの
- 従来のゲーム的なパケットを投げまくるようなスタイルの通信は L4S の制御と衝突する可能性がある
    - ルールを守ってお行儀良く実装すれば問題はない


### 【EM-uNetPi】

- 更新版を公開
    - ドキュメントに従って自身でサーバを構築すれば現状でも使う事が可能
    - https://github.com/KONAMI/EM-uNetPi/blob/master/docs/MetricsMonitor.md
- 目的 : v4/v6 のメトリクスを集計して本当に v6 が早いの？というのを可視化したい
- いろんな場所で計測した結果(スクショ)をアップして欲しい
    - 地理情報をマッピングして統計データができる
    - 普段ユーザが遊んでいる環境を計測したい


# 次回開催

- 開催予定日時
    - 2025/12 – 2026/1
- 議題
    - IETF 124 報告
    - 技術書典19 報告
    - 「ゲーム業界のリアルタイム通信プロトコルにおける課題を洗い出す」残件
    - 「QUIC等標準のプロトコルを用いた場合の検討・議論・事例収集」に関するネタ
- 場所
    - 開催場所を提供して頂ける会社様募集！

