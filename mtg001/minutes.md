ゲームリアルタイム通信プロトコル 第一回会合
===
当資料は "ゲームリアルタイム通信プロトコル 第一回会合" の議事録(非メンバー向け)です。


# 当会の方針に関する議論

議論内容は割愛し結論のみ記載しています。

## 【活動目的】

ゲーム業界においてリアルタイム通信で使用されるプロトコルについて情報交換を行い、業界全体でリアルタイム通信の品質向上を目指す。

## 【活動】

以下を複合的に実施。

1. 招待性の Slack 上で活動
    - Slack ログが消える(無償版は 90 日で見れなくなる)問題
        - 主幹が保存し、メンバー向けに公開場所を作成することにより問題を回避する
2. リアルでの会合 (開催頻度は後述)
3. CEDEC 等のカンファレンスでの報告

## 【リアルでの会合】

- 開催形式
    - リアルとオンライン(Zoom)のハイブリッド
- 開催日
    - 平日 (仕事として参加し易いのを重視)
- 議題
    - IETF であった当会の関連事項の報告
    - 事前に挙がった議題に関する協議
    - その他関連した発表や情報共有(あれば)
- 頻度
    - 年三回
    - IETF とは別に事例の発表や外部講師の招集等があれば特別開催も可 (最大で +3 回程度)
- タイミング
    - IETF の一か月後程度


## 【コミュニティ名について】

良い名前募集中！
(良い感じの略称もあると嬉しいです！)


## 【Milestone】

- ①(イマココ)ゲーム業界のリアルタイム通信プロトコルにおける課題を洗い出す
    - 期間 : 2024-2025
- ② QUIC 等標準のプロトコルを用いた場合に上記課題が解決できるか、解決できないものは何かを洗い出す同時にこの問題点を解決する為に必要なものは何かを議論する
    - 期間 : 2025-2026
- ③(必要であれば)上記の要素を取り入れたゲームのリアルタイム通信プロトコルの標準化を進める
    - 期間 : 2026-

### FAQ

- ゲーム業界外の人をもっと巻き込んだ方がいいのでは？
    - ある程度①の内容が詰められたタイミングでISP/CDNベンダー/ルータベンダーのような方々にもお声がけ予定です
- ゲームNW接続性WGのように、JAIPA傘下の組織構成の体で活動すべきでは？
    - 上記同様にある程度活動が広がったタイミングで議題に挙げようと思っています
- 標準化だけではなく実装が欲しい
    - 標準化を提案するにあたりOSSとして作る流れになると思います(がまだ具体的なイメージは無しです)
- 独自実装やOSSは組み込みが厳しいのでプラットフォーマに参画して欲しい
    - 一部のプラットフォーマーの方の参加は交渉中です
    - 興味がありそうなプラットフォーマーの方とお知り合いの場合は繋げて頂けると大変助かります


# IETF 118 報告

## ゲーム系インフラエンジニア目線のIETFにおけるQUIC, HTTP/3動向。

[ゲーム目線のインフラエンジニア IETFにおけるQUIC, HTTP3動向](/quic_and_h3_at_ietf.pdf)

### 議論:ゲームのリアルタイム通信に WebTransport は必要か？

- WebTransport はオーバースペック？
    - ゲーム通信に QUIC を組み込んでおり、検証を進めていると WebTransport 要らないな、と思い始めた
        - 音声通話は既に WebTransport で実装した実績がある
    - ゲームでは Reliable/Unreliable なストリームがあればその上の層は要らない
        - WebTransport レイヤーの若干のオーバーヘッドも気になる
        - WebTransport(quic) は Unreliable(DATAGRAM) な通信も一つの実装で完備できるのが良い
- WebTransport を止めて quic を採用した際の問題
    - quic が疎通しない環境での TCP へのフォールバックが実装が煩雑になりがち
    - 更に完全な P2P を諦めてリレーを挟んでいる場合、 TCP/UDP のリレーどうする問題もある
- WebTransport のメリット
    - ロードバランサの問題が少な目
    - URI でエンドポイント識別指定可能なので設定が楽
    - 動画とコントロールを同じコネクションに載せられるので、同じ輻輳制御や優先度制御ができる
        - クラウドゲーミングで似たような話があった
- P2P の観点
    - IPv4 と IPv6 でも TCP/UDP と同様の問題がある
        - IPv6 オンリーの ISP も登場し始めた
        - スマホでも IPv6 しか振ってこない環境が出始めた
            - NAT64 もセットなので現段階で繋がらないようなことはまだない
        - NAT64 すらなくなった場合の対策が必要
            - 設備を嫌がる企業が出始めたタイミングまでに対策を考えておく必要がある
            - ユーザからの報告もなく諦められるようなケースは避けたい
    - お金があればリレーするのが楽
        - 予算の問題は負担を複数タイトルで分散する建付けにする等の工夫は必要
        - 売り切りタイトルだとリレーの維持費が厳しいので P2P を用意しないといけないことも多い
    - 暗号化する場合に誰か一人がホストになるタイプにすると複雑になり過ぎる
        - WebRTC の SFU のような形で逃げる手もある


## 暗号化まわりとCCWGについての報告

[暗号化まわりとCCWGについての報告.pdf](/encryption_and_ccwg_at_ietf118.pdf)

### 議論:Areion について

- Areion 補足
    - 自前で実装しているような OpenSSL 以外の実装にも適用可能
- Areion 説明会の実施
    - イエラエの人にお声がけして説明会を開いて頂くのも良さそう
    - セキュリティ強度の評価等を踏まえると、タイミング的にはもう少し先の実施が良さそう
- Areion 以外の選択肢
    - AEGIS 等のライトウェイトな実装が出てきている
        - AEGIS は Fastly や BoringSSL でも実装している
- 暗号化の負荷について(後述の「事前募集した議題」項でもう一度議論しています)
    - UDP だとアプリケーションレイヤーやパケット転送部の負荷の方が気になる可能性の方が高い
    - AES でまずはやって、どうしてもパフォーマンスが出ない場合に導入を検討するくらいで良いのではないか
        - Areion も AEGIS も Intel AES を使って動作する
        - ゲームだと AES をハードで処理できない環境もあるので注意は必要
        - ソフトで処理する場合は ChaCha 一択

### 議論:リアルタイム通信と輻輳制御

- 輻輳制御に関するデータ
    - ゲームのリアルタイム通信においてどのくらいの通信量から輻輳制御が必要になるのか、というデータはまだない(竹原は把握していない)
        - リアルタイム通信と輻輳制御を絡めて語られ始めたのは最近なのでデータそのものが少ない
    - 現時点では一般的な輻輳制御の論文やデータを参考にするのが良さそう
- UDP への輻輳制御の適用
    - 中継機等が複雑になっている現代のネットワーク環境では UDP においても少し手加減した方が遅延が有利になるかもしれない、という話なので必ずしも断言はできない
        - ゲームは送信するデータのサイズは小さいが、だからと言って本当にバーストで送信処理を実施しても良いのか
        - IETF でも議論に上がり始めた段階
- 従来の輻輳制御との対比
    - TCP や QUIC の輻輳制御は今送れるデータが X byte である、というような方式だが、 IETF 118 ではリアルタイム通信向けの新しい輻輳制御を遅延感知型(delay-sensing CC)という言葉で言及されていた
    - ゲームでの実装は例えば送信する移動データの FPS を 60 から 30 に落とすようなイメージ
        - これであれば難易度的荷も問題ない
    - これを輻輳制御で実装するべきものなのかは議論の余地がある


### 派生議論:quicと通信規制について

- 通信規制
    - quic は一般的なプロトコルなので、動画配信サイトの巻き添えを食らって規制を受ける可能性がある
        - 大学や企業でも塞いでいたり制限を掛けている場合がある
        - ルータベンダーや ISP 的には動画は帯域が大きいから規制したいはずだが、ゲームはそうでもないので許して貰える可能性は高い
        - quic は DPI で監視できないので、わざと落としてフォールバックさせてコントロールするようなものもある
    - ゲーム専用のプロトコルにすることで規制問題を回避できるかもしれず、専用プロトコル策定のモチベーションになり得る
- ポート設定による回避
    - ポート 443 以外を使って通信する手もある
        - 最近は家庭用ルータでも UDP:443 のセッションタイマーを短くする等しているものも出てきているのでポートをあまり変えたくない
        - 443 以外の方が疎通性が高いかというとそうでもない
- この議題についてはゲームNW接続性WGと近い話題なので、うまく連携して議論を深めていきたい



# 事前募集した議題

## 議題一覧

- 暗号化
    - 暗号化そのものの必要性
    - 難読化の必要性
    - 処理負荷
    - 選択ライブラリ
    - パーシャル暗号化
- QUIC
    - QUIC に期待するもの
    - 移行に関する課題
- 現状確認
    - 現在のトレンド
    - 不足しているもの
    - リアルタイム通信に求める時間単位(目標値)
- 将来業界に必要な要素
    - よりカジュアルに使えるように必要なこと
    - HTTPと同水準で広められるには？
- リアルタイム通信技術の勉強・教育方法
- 実装
    - パケットハンドリング
    - ゲームエンジン/通信ライブラリの選定
    - ルータ透過性


## 議題割り振り

- 暗号化 → ①, ②
- QUIC → ②
- 現状確認 → ①
- 将来業界に必要な要素 → ②
- 実装 → ①、②
- 勉強・教育方法 → ①、②
- ルータ透過性 → ゲームNW接続性WG へ


## 議題:現状確認

たたき台があった方が良さそうなので主幹側で次回までに作成しておく。
今回事前議題に出たもの以外の課題についても洗い出しを実施予定。


## 議題:暗号化

### 暗号化そのものの必要性/難読化の必要性/処理負荷

- 暗号化の意義
    - 意義が薄いという意見
        - ゲームの場合、攻撃時にはゲームアプリケーション自体を逆アセンブルされたりメモリを見られたりするので暗号化の意味が薄い
            - そこまで頑張って暗号化する価値があるのかというと難しい
    - 意義があるという意見(消極的賛成を含む)
        - パケット送信のコストに対して暗号化のコストが軽微なので、ヒントを与えないという意味でも暗号化を行う、という考え方もある
        - P2P の場合、ホスト側で改ざんチェックをするのが大変なので、通信の暗号化で防御をしておくにこしたことはない
        - モバイルゲーム観点ではプライバシーイシューとして暗号化は欲しい
            - 野良の Wi-Fi でゲームプレイしている際にそのパケットから個人情報が漏れるような事態は避けたい
        - 送信元の改ざんを防ぐ目的での導入もある
            - この意見は CEDEC 2023 でもあった
    - IETF では提案時に通信経路の暗号化が必須
        - 暗号化をどうしても外したいなら下のレイヤーがやってくれるのでこの仕様では言及しないよ、というスタンスを取る手もある
            - 例えば WebTransport では暗号化については quic がやるので仕様には含まれていない
- 暗号化のコスト
    - 最近のゲームの通信では実際に暗号化の計算コストが問題になる話はあまり聞かない
        - 昔は 1,2 割性能が落ちるような話はあったが最近は聞かなくなった
        - ハードウェアアクセラレーションやカーネル側の最適化によりほぼなくなった
    - サーバ側でのコスト
        - Fastly の例
            - 一番のボトルネックはメインメモリのバンド幅で 130G/sec 程度
            - CPU の暗号化は Intel のコアは一つで 6G とか出るので問題になっていない印象(64 コアだと 500 を超える)
            - NIC のオフロードを使えば更に早くなる
        - サーバで他のアプリケーションを動かしている場合に気になることもある
- 暗号化の議論の整理
    - ゲーム業界特有の問題として、通信者本人が攻撃を仕掛ける、という特徴がある
        - 一般的には第三者からの攻撃を守る意味で暗号化の話がされる
    - 誰と誰の通信を何から守りたいのか、を明確にして分けて議論すべき
        - 暗号化と難読化で言葉を分けた方が良い
        - 権利の無い第三者からの攻撃を守りたいのか、通信当事者からの攻撃も守りたいのか
    - クライアント、サーバ、データセンター内等セグメントを分けて話した方が良い
    - 次回までに主幹で整理して、再び議論を実施


### 選択ライブラリ

- 異なる OpenSSL バージョン問題
    - gRPC 等外部の実装を入れた際に衝突することがある
    - 衝突した際の対処がしんどいので基本 OS のものを使いたい
- 暗号化のライブラリは選択肢が少ない
    - OSS が OpenSSL か BoringSSL かしかほぼ選択肢がない
        - 更に中身は一緒


## 議題:実装

時間の関係上次回の議題へ。


## 議題:リアルタイム通信技術の勉強・教育方法

- 資料がない問題
    - 「ゲームのリアルタイム通信」に特化した資料がほとんどない
    - 特に書籍がほとんどなく、体系立って学ぶのが難しい
    - 以前 CEDEC で講演を実施した際は、みんなそこからヒントを得て実装しているような雰囲気はあった
- Unity の Netcode for GameObject で学ぶ
    - Netcode for GameObject はインターフェースが見えてて、トランスポートが入れ替え可能なのでゲーム部分を知らなくても書ける
    - 教育としてやったわけではないが、 quic で Netcode for GameObject を動かしてみるようなことをやってみたことがある
        - 実装が間違っている際にすぐわかるので教育に使うのも良さそう
- そもそも人が居ない問題
    - 教育方法以前にそもそもリアルタイム通信に詳しい人が少ない
        - 2000 年前後からやり始めたが後継者が居ない例もある
    - 新しく実装する機会が少ない
        - ゲーム性に依存するような特別な理由がある場合でもない限り、中々リアルタイム通信実装を下から作ることがない
    - ゲーム会社という括りだと毛色が違う
        - 組み込みに近い、CPU やハードまわりが好きな人じゃないと付いていけない
        - ネットワークがメインの会社であればそういう人たちはいるが、若手でやろうとしたがる人がいない
        - ゲーム会社にはゲームを作りに来ている人が多い
- 教育事例
    - 最近 NAT Type や v6 P2P について教えて欲しいという声が上がってきたので勉強会を実施予定
        - 実際にログを読まないといけない、トラブル時に何故つながらないか分からないので理解したい、という動機
- 教育への障壁
    - 前提知識がたくさん必要問題
        - ゲームのアプリの組み方からプロトコル仕様、ネットワークの運用等広範囲に渡る
    - マルチスレッドプログラミング難しい問題
        - リアルタイム通信はマルチスレッドが複雑になるので難しくなる
        - キャッシュの考慮等経験も必要
    - 言語が辛い問題
        - C/C++ の実装がほとんどなので若い人には辛い
            - ゲーム会社も C/C++ を書ける人ばかりではない
            - Unity 独自エンジンのスクリプトで C# 採用事例も
        - Rust も増えてきたが C/C++ 程ではないにせよ難しい
- 社外へと目を向けてみる
    - 昨今の大学のゲームサークルの様子を見るとネットワーク担当はいるので、そういう人にアプローチを掛けるのは良さそう
        - 大学や専門学校の講義として一本カリキュラムができると良い
            - そこで作った資料を社内に展開するとかもできる
            - 専門学校の講師が社内にいるのでやったことがある
                - 人気が全く出なかった(やりたくない、やってもつまらない)
    - 海外だと国内に比べて詳しい人の割合が多いのでそこにアプローチを掛ける手もある
