ゲームリアルタイム通信プロトコル 第三回会合
===
当資料は 『ゲームリアルタイム通信プロトコル 第三回会合』 の議事録です。

※注意事項※  
当議事録には、当日使用した以下の資料への口頭補足及びそこから派生した議論のメモが記載されています。資料とあわせてご確認ください。  

- [Media over QUIC の通信プロトコル側から見て](https://speakerdeck.com/flanoyuki/media-over-quic-notong-xin-purotokoruce-karajian-te)  
- [ゲームリアルタイム通信プロトコル第三回会合](/mtg003/summary_of_discussion.pdf)


# IETF 120 報告

- ゲームでのユースケース
    - キーフレームを流すのに使えないか？
        - ゲームロジックとの同期が難しいのが課題
        - 動画メインのものでないとマッチさせるのは厳しそう
        - MQTT からのリプレースくらいのイメージ？
    - 思いつくユースケース
        - MMO のような大量のデータ(のあまり重要でないもの)を流す
        - ゲーム内からの配信(ライブ等)
- 映像と音声の同期の話
    - トラック同士を同期させたいという話がよく出ている
    - ゲームでも送信経路が異なるチャットと映像がずれる問題はままある
        - 特に音声チャットは特性が違うのでバッファの調整がシビア
        - VR Chat のようなアプリやゲーム内ライブ配信での音声と映像の同期ずれは対策がとても難しい
        - ユーザがゲーム内チャットでタイミングをあわせようとしてずれてクレームに発展したことも……



# ゲームのリアルタイム通信に必要な要素の整理


- 「必要な要素」について「仕様」、「実装」、「環境」の分類別に分けてまとめた方が良さそう
    - 例
        - 実装例 : コンシューマプラットフォームに移植し易いか
        - 環境例 : 疎通性の高低
    - 今回の議論をベースに次回までに主観がまとめておく


### 疎通性

- P2P の接続性と分けて議論するのは良い話
- もう少し分かり易い用語の定義ができると良さそう
    - 「疎通性」という言葉だとイメージがぱっと浮かび辛い
- 疎通性は最近重要
    - RTMP のようにルータが中身を見て例外処理をするようなプロトコルがある
    - QUIC のように中を暗号化した方が疎通性は上がる
    - VPN 張ったら疎通するようになるケースとかもあったり(勿論逆もある)
- ゲーム業界的にはとても重要
    - フォールバックの話はいつもつきまとう
- 繋がらないユーザのサポートも大変
    - プロトコル仕様に疎通性に関する情報が予め乗っていると助かる
        - 例 : WebRTC の ICE の複数経路があった場合の情報
- エコシステムの充実
    - WireShark で見易い・デバッグし易い
    - QUIC の qlog のようなビジュアライザが標準で備わっている
    - その他パーサの充実等
- OpenTelemetry のようにオブザーバビリティを高めたい
    - オーバーヘッド的にリリースするアプリケーションで有効化するのはプロダクト側に認めて貰えないかもしれない
    - 疎通性を高める為に情報を集めるとそれが「ユーザ情報」にあたるかも考慮する必要がある
        - どこまでを「ユーザ情報」とするのかのジャッジは難しい
    - 更に複数点で計測した情報を統合して観測したい
        - 「どこで遅かったか」、「どこで詰まったのか」というような情報を取得できると良い


### 暗号化

- できるだけ既存の仕組みに乗っかりたい
    - QUIC を採用するメリットの一つ
- 標準化する場合は暗号無しはあり得ない状況なのでその点は考慮しておく必要がある
- QUIC の暗号化は再送時に再度暗号化し直すオーバーヘッドが気になる
    - 暗号化しておいたパケットをそのまま投げ直すことができれば節約できそう
    - リオーダーしてから暗号化するのか、その逆なのかも絡み難しい問題
    - とはいえ、独自の実装は避けたいので標準には乗りたい
- 暗号化不要な通信について
    - 暗号化の切り替えが仕様や実装面の重しになるのであれば全て暗号化するというのも一つの選択肢
        - 最近はゲームだからと言って暗号化が不要、という括りでは語れない
            - ユーザの情報にはセンシティブなものもあり、暗号化不要なケースがあまりない
        - そもそも暗号化不要なデータには高度な機能も不要なのでは？
    - 暗号化したくないケース
        - 物量(情報量)が多いゲームでは今でも暗号化したくないケースがある
            - 多人数参加の FPS や MMO が該当
            - サーバ負荷が一番の重し
                - アクセラレータが乗って軽くなっても暗号自体の負荷も上がっているのでいたちごっこな面がある
- ゲームによって事情が違い過ぎるので、当会の活動としてまとめられると良さそう
    - 例
        - こういうデータなら暗号化はしなくても良いというユースケース
        - 暗号化しない場合のクライアント・サーバでの対策の指針
    - 実際に暗号化していないゲームもまだ多く存在している
        - 面倒だからといった理由ではなく、こうしたケースでこういう対策をしているのであれば暗号化をしないでも問題ないです、まで啓蒙できると良さそう
    - 今後の課題(別途当会で相談していきましょう)


### 難読化

- プロトコルの仕様として難読化を含めるかどうか
    - 今後トラフィックを機械学習されてごにょごにょされるようなケースが出てくるのであれば効果がありそう
        - Wi-Fi と AI チップを統合して高速化するようなものも出てきている


### 制御アルゴリズム

- パケロスや RTT に応じてアプリ側での制御も必要になる
    - WebRTC のようにパケロスや RTT の値に応じて優先順位が低いデータ量を落とす
        - アプリ側がこの実装をやるのは大変なので、グラフィックスにおける LOD のようなことを通信でもできると良いが……


### 再送制御

- 特定時間内であれば再送するような柔軟な制御ができると良さそう


### 優先度

- 標準の仕様だと機能不足で自前実装する未来も見えるが、あるにこしたことはない


### Connection Migration

- アプリケーションにエラーを返さないのは非常に十分
    - 切断処理を走らせないで良いのは大きなメリット
    - 判定が面倒なケースを Connection Migration で吸収して欲しい
         - Wi-Fi → Wi-Fi 切れた → 5G → 5G 切れてないけど Wi-Fi 復活 → Wi-Fi に戻したい
- 実装面が煩雑になりがちなのでそこも簡単に組み込めると良い
- 切り替え時の処理時間も短いと良い
    - 後述のマルチパスの話へ


### Multipath

- ユーザ目線では通信量が増えるのも問題
- P2P の場合接続性がパスによって異なると地獄
- 最近だとゲーミングマンションのような二回線引けるケースも増えて来てはいる
- 現状課題が多いので今の所は Connection Migration の方に期待したい
    - QUIC を採用した発表で苦労が語られるはず


### 移植容易性

- 移植容易性の他にも、OSS や情報量が多いプロトコルは採用し易いよね、というような観点もあっても良い
    - ゲーム業界的には C/C++ が嬉しいというような言語面等も
    - ゲーム業界向けプロトコルを提案する場合には外す必要はあるが、当会の情報共有としては有益なはず
    - ゲーム業界で QUIC の採用が進まないのはこの辺りの影響も大きい認識
- ネットワーク初心者向け(実装難易度)のような指針もあると良さそう


### その他の要件

- Pub-Sub のような中継の観点があっても良さそう
    - ゲームサーバは全員の位置情報を送るが、受け取り側が中継サーバに情報(優先度とか)を送ってそれを元に中継者が調整する、とか
- Slack でも随時募集中



# プロトコル


### SCTP

- SCTP over UDP を選択したのは歴史的な経緯で今選ぶ理由はあまりない
    - WebRTC には採用されているので、そこで活用しているケースは今でもあり得る


### 全体

- プロトコルの関係図があると良さそう
    - Xxx over Xxx のようなものが多いのでそこがまとまっているようなもの


# スケジュール(再掲)

- CEDEC 2024 で QUIC がの講演が無かったので「②QUIC等標準のプロトコルを用いた場合の検討・議論・事例収集」は少し後ろにずれ込みそう


# 主幹からの連絡

### 次回開催

- 2024/12 中旬ごろ予定
- 次回議題
    - 「ゲームのリアルタイム通信に必要な要素の整理」の続き (実装に関する情報共有)
    - 会合での情報交換以外に当会合でできることがないかの議論
    - CEDEC 2025 応募についての議論

