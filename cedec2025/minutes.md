ゲーム業界におけるリアルタイム通信プロトコルの 最適な選択肢を探るラウンドテーブル 2025
===
これは CEDEC 2025 にて行われた "ゲーム業界におけるリアルタイム通信プロトコルの 最適な選択肢を探るラウンドテーブル 2025" の議事録です

# 議題以外に関する内容

### 当ラウンドテーブルの目的

リアルタイム通信で使用されるプロトコルについて情報交換を行い、業界全体でリアルタイム通信の品質向上を目指す。


### 取り扱う内容

“プロトコル”にフォーカスをあてて議論を行う。

- RFC が策定された標準プロトコル
- 標準の拡張プロトコル
- 準標準(draft止まりの)プロトコル
- オープンではあるものの非標準のプロトコル
- 各社で独自拡張を行っているプロトコル


### 取り扱わない内容

- ネットワークの接続性に関する問題
    - “ゲーム・エンタメネットワーク接続性課題検討WG” へ
- スケーラビリティ等のサーバ運用に関する話
- ロールバック等の同期に関する技術


### 議題の選出

以下議論で盛り上がったものの、ベストプラクティスや実例がまだまだ不足しており、答えが出ていない項目を選出

- CEDEC 2023 のラウンドテーブル
- ゲームリアルタイム通信プロトコル コミュニティ


### ゲームリアルタイム通信プロトコル コミュニティとは

- CEDEC 2023 の同ラウンドテーブルを機に発足
- 以下を複合的に実施
    - 招待性の Slack 上での情報交換
    - リアルでの会合
        - 年三、四回実施
        - これまで計五回開催
    - CEDEC等のカンファレンスでの報告
- これまでの記録は以下を参照
    - [GitHub - TakeharaR/game-realtime-protocol](https://github.com/TakeharaR/game-realtime-protocol)
- 参加歓迎
    - 現在 26 名が参加
    - 以下"コミュニティ"と記載


# 1. マルチプロトコル戦略

特定のプロトコルがブロックされる環境下での切り替え手法などマルチプロトコル戦略に関する議題

### お題の例

1. マルチプロトコル実装コストと運用事例
    - 切り替え時のレイテンシや信頼性の変化の事例や実測データ
    - 通信品質に影響を与えないシームレスなプロトコル切替の実装や運用例
    - Happy Eyeballs の実装や運用事例
    - 状況やデータの特性によって使い分けの事例
    - 保守やテスト環境に関するノウハウ
2. UDP/RUDP 以外のプロトコルでリアルタイム性を確保するための工夫や事例
    - ゲームジャンルやシステム構成
    - UDP/RUDP と比較した実測データ


### フェイルバックの実装・活用事例

お題 : フォールバック実装は、大体大元よりなんらかのコストが増えたり、品質が悪くなるが、逆にフェイルバックを実装・活用して、なるべくプライマリーのプロトコルを使うようにしている事例はあるか？

- 事例について
    - フェイルバック例
        - UDP が通らずに TCP へフォールバックした後、 UDP への疎通ができるようになった場合もそのまま TCP で通信している
        - 通信状況が悪くリレーサーバに一時的にフォールバックした後、状況が改善してもそのままリレーサーバ経由で通信している
    - 講演者が軽く調べた限り実際にゲームで採用された事例は見つからなかった
    - 会場アンケート : フェイルバックを実装・採用したことがあるか？
        - 採用事例無し
- ユースケース
    - 最近はユーザが移動しながら遊ぶ事例が多く、こういった事例は今後も増えていくと思われる
        - こうした場合にアプリを再起動しないと快適にプレイできないのは問題
- 実装・運用面の問題
    - 実装コストもだが実行コストも高くなりそう
        - 実際にやろうとする場合、例えば TCP, UDP の疎通状況やパフォーマンスを常に監視しないといけない
- 必要性
    - 現実的な問題としてはまずはマルチコネクションの実運用・課題解消が先に来るのではないか
        - 「現状では」、そもそもこうした環境変化が発生するタイミングはネットワークそのものも切り替わる(切断が発生する)ので(再接続により)最適な通信方法に戻ることの方が多そう
        - 疎通に関するフェイルバック以外に、例えばパフォーマンスの観点でのフェイルバックもあり、こうした場合は現在でも実用は可能ではある
- マルチパス
    - プロトコルのフェイルバック(マルチプロトコル)以外にマルチパスでのフェイルバックも考えられる
    - 各 OS での対応も進んできてはいるので実装できる環境は整いつつある
        - iOS はすでにマルチパス TCP に対応しており、使う時にポリシーの指定が可能
    - 車載等ゲーム業界外で積極的な業界があるので、そこの仕様策定にうまく協調できると良さそう
        - ゲーム会社が各自で実装するのはかなり大変なので、うまく OSS 等が低レイヤーを吸収してくれて、気軽に採用できるようになるのが理想
- フォールバック
    - 会場アンケート : そもそも TCP → UDP 等のフォールバックをしている？
        - 三割以下のかなり少ない結果 (正確な数値はカウントする余裕なかったので体感の数値)


### プロトコルを選ぶ時の「低遅延」以外の判断基準

お題 : プロトコルを選ぶ時の「低遅延」以外の判断基準。例えば、差分転送がしたいので遅延は抑えたいけど reliable な通信をしたい等

- 補足
    - 遅延は減らしたいのは当然あるとして、それ以外の判断軸で面白い・変わった事例があれば知りたい
        - MMO でアイテム情報はロストしないように reliable を使っている、というような一般的なケースではなく、少し特殊な事例
    - タイトルのリアルタイム性の高低によってもかなり判断基準が変わりそう
- 採用実績があるケース
    - ゲーム業界は他のタイトルでの実績があると採用されるケースが多い印象
    - OSS として公開されていると尚良い
- カスタマイズ性があるケース
    - ゲームはデータの性格によって reliable や order 等への要求が異なるので、ここを簡単に指定できるようなプロトコルだと良い
    - QUIC は Datagram はあるが、ゲーム的にはより細かい指定ができる方が良い

### hole punching

会場アンケート : IPv6 での P2P での hole punching について

- v6 でやっている → 1
- v4/v6 両方でやっている → 1


### 当日議論しなかったお題(講演者用意)

- フォールバック以外の選択肢トンネリングやマルチパスを運用しているケース
    - HTTP等をトンネルプロトコルとして他のプロトコルを流す
    - 関連
        ‐ RFC 9298 Proxying UDP in HTTP
        - RFC 9484 Proxying IP in HTTP 
        - RFC 9297 - HTTP Datagrams and the Capsule Protocol


# 2. 通信制御技術

標準的な実装では得られない、ゲーム特有の要件にフォーカスした制御アルゴリズムに関する議題

### お題の例

1. 標準の輻輳制御や再送制御アルゴリズムではなく、独自のアルゴリズムの実装や運用事例
    - 結果としてユーザー体験が向上した事例
    - アルゴリズム戦略の具体例
    - レイテンシと帯域のトレードオフにおける具体例
    - 評価方法や環境構築に関するノウハウ
2. ストリームとデータグラムにおけるパフォーマンス比較や実測データの事例
3. クライアント、サーバ実装における最適化事例
4. 最新のアルゴリズムを別のプロトコルに適用した事例
    - BBRv3 等、標準化が進んでいる最新の制御アルゴリズムを試してみた事例
    - QUIC の再送制御アルゴリズムを RUDP 等の独自プロトコルに適用した事例
    

### IPv6 の選択

お題 : Happy Eye Ball v3 のように、ゲーム業界でも IPv6 を優先して使うべきか。それとも、その逆で IPv6 はフォールバックとして扱うべきか。もしくは、フェアに並列で接続試行を行うべきか

- 補足
    - v6 の方が速い地域だと v6 を、 v4 が速いならそちらを採用したい
- 環境的な要因
    - v4 を優先しているようなハードも存在している
        - タイトルの P2P の実装事情を踏まえた上でそうなってそう
        - 逆説的にゲーム業界のタイトル側が積極的に v6 対応していくことで変わっていくのではないか
    - AWS がパブリック IPv4 アドレスの利用料金を上げた事例のように外圧により推進されていく可能性もありそう


### 輻輳制御の必要性

お題 : 輻輳制御の必要性(輻輳制御せずにリアルタイム通信時に非リアルタイムな通信が滞ったり)や通信レイヤー以外も含めた輻輳制御(adaptive に通信内容を削減したい等)について

- QUIC の事例
    - 「CEDEC 2025 『ゲームにおけるリアルタイム通信への QUIC導入事例の紹介』」にて QUIC Datagram で小さいパケットデータを投げていたら輻輳が発生した事例発表があった
        - QUIC Datagram は輻輳制御が入っているがそれでもダメだったケース
- 会場アンケート : 独自の輻輳制御を入れているか
    - BBR の採用事例
        - (ライブラリの)ユーザ(アプリ開発者)側が通信データを何も考えずに大量に送信してしまった際の防御機構として採用
    - その他は採用事例無し
- ゲーム向けのネットワークライブラリや SDK 事例
    - 割と独自のアルゴリズムなケースが多い
    - 例
        ‐ [UE : FNetworkCongestionControl](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FNetworkCongestionControl)
            - BDP ベースの輻輳制御
        - [ValveSoftware/GameNetworkingSockets](https://github.com/ValveSoftware/GameNetworkingSockets)
            - DCCP(RFC 4340)のack vectorモデルやQUICのアルゴリズムをベースとした再送制御
            - ゲーム向けの固有仕様満載
        - [RakNet](http://raknet.com/)
            - [UDT (UDP-based Data Transfer)](https://udt.sourceforge.io/poweredby.html#:~:text=,to%20two%20orders%20of%20magnitude) ベース
    ‐ [KCP](https://github.com/skywind3000/kcp) 等も含め、海外の実装は輻輳制御や再送、フロー制御等をゲーム向けに積極的にカスタムしているケースが多く見受けられる
        - 逆に日本だとこういう話をほとんど聞かない
- ゲーム業界外
    - IETF の議論でも WebTransport でブラウザ(JavaScript)側で輻輳制御アルゴリズムを指定できるようにするような議論がある
- adaptive に通信内容を削減する話
    - 補足
        - ネットワーク状況に応じてデータを削減するような事例があれば知りたい
        - 動画配信だとネットワーク状況に応じて解像度や FPS を落としたり、誤り訂正を用いてユーザ体験の質を高めている
    - 誰がどこでやるか問題
        - 実装的にはプロトコルレイヤーでやって欲しい
            - フラグを設定しておくと状況に応じて勝手に削ってくれるようなイメージ
        - 頻度ではなくデータ量(ビット数やデータ送信するキャラ数)を変えたいケースはユーザ側でやらなければならない
            - ゲームではここまでやらないとダメなケースな方が多い
        ‐ ゲームではデータをまとめてパケット量を減らすようなアプローチもよく採る
        - ライブラリ側で勝手にやらないで欲しい、と言われるケースもある


### 当日議論しなかったお題(講演者用意)

- L4S
    - [RFC 9330 - Low Latency, Low Loss, and Scalable Throughput (L4S) Internet Service: Architecture](https://datatracker.ietf.org/doc/rfc9330/)
    - IIJ様の資料がとても分かり易い
        - [TechTrend Talk Series vol.11 L4Sで低遅延インターネットは実現できるか？ IIJ技術研究所 長 健二朗](https://seminar-materials.iijlab.net/iijlab-seminar/iijlab-seminar-20240528.pdf)
    - T-Mobileで使用可能になったとか
        - [T‑Mobile Is First to Unlock L4S in Wireless — A Key Step Toward a Smarter, Programmable 5G](https://www.t-mobile.com/news/network/unlock-l4s-5g-advanced)
    - Comcast(米ケーブルテレビ)でもサービス開始している
        - [What is Latency?](https://corporate.comcast.com/stories/latency-speed-explainer)


# 3. 暗号化とパフォーマンス最適化

標準的な実装では得られない、ゲーム特有の要件にフォーカスした制御アルゴリズムに関する議題

### 暗号化注意事項

[ゲームリアルタイム通信プロトコル 第二回会合 議事録](https://github.com/TakeharaR/game-realtime-protocol/blob/main/mtg002/minutes.md)より

- 用語定義
    - 暗号化
        - 通信データを暗号化する
        - 第三者からの盗聴や成りすまし、改ざんを防止する
    - 難読化
        - ドライブやメモリ等のローカルに保存されるゲームのデータそのものを暗号化する
        - ユーザ(通信者)本人からのデータの不正利用やチートを防止する
- 話題に挙げる際は発散しないようスコープを限定する
    - 攻撃者
        - ユーザ(通信者)本人、第三者 等
    - 防ぎたい攻撃対象
        - チート、盗聴、成りすまし等
    - セグメント
        - クライアント、サーバ、データセンター 等


### お題の例

1. 暗号化を敢えて行わなかった事例とその理由
    - ゲームジャンルやシステム構成
    - 状況やデータの特性によっての使い分けの事例
    - 運用上のリスク管理方法
2. 暗号化アルゴリズムのパフォーマンスへの影響や強度に対する評価手法
    - 暗号化処理が負荷を増大させた事例(サーバ・クライアント)
    - ハードウェアアクセラレーション等の負荷軽減策の導入事例
    - 負荷の測定方法と許容ライン
3. 軽量な暗号アルゴリズムの採用事例
    - 軽量アルゴリズム選定の理由
    - パフォーマンスの実測値
    - 独自の暗号化アルゴリズムとその評価手法


### 暗号化の必要性

- 会場アンケート : 暗号化をすべきか？
    - 半々程度
- 暗号化不要の論拠
    - どんなに少なくなったとしても暗号化の処理はコストでありユーザ体験を損なう要因になりえるので選択肢として外せるようになっているべき
- 暗号化必須の論拠
    - 第三者の介入がないという意味で保証が欲しいケースがある
- リアルタイム性の高低の影響
    - 格闘ゲームとカードゲームで暗号化のモチベーションは違う
    - 議論が発散しないような論点と観点をユースケースとしてまとめるのが大事そう


### 当日議論しなかったお題(講演者用意)

- 軽量暗号化アルゴリズムは採用可能か？
    - 昨今のゲームはパケットサイズが肥大化しており、軽量暗号化アルゴリズムが適合しない？
    - ショートパケット、ロングパケットのサイズイメージは？
    - 軽量暗号化アルゴリズムを入れるのであれば独自の難読化で良いのでは？という印象も強い？
- そもそも暗号化のコストは本当に気になるか？
    - 昨今はアクセラレーターも標準装備であり、負荷がそこまで気になるケースも減った？
    - 実際に負荷が気になった方はいる？
        ‐ 気になる場合、どのくらいの物量だったか
        - この辺りは前回のラウンドテーブルや"コミュニティ"の第一回会合でも話題になったが答えが出ていない


# 4. 技術者育成と知識普及

高度、複雑化するリアルタイム通信におけるプロトコル関連技術を如何に効率的に基礎から実践レベルまで教育し次世代に伝えていくか

### お題の例

1. 拡大する基礎知識への対応
    - プロトコルレイヤーの知識はどこまで必要か
    - 教育に使用しているカリキュラムや教材
2. 特に大規模なゲームのリアルタイム通信に関する勘所をどう養うか
    - 複雑化するネットワーク環境をどう把握していくか
    - 様々な実環境への対応策やノウハウの蓄積
3. 学生・新人にリアルタイム通信に興味を持って貰う為の施策

### 教材的なタイトル

お題 : オンラインゲームは普遍的ではない(サービス終了が存在する)ので、こういう通信パターンといえばこれ、のような教材的なタイトルがカテゴリごとにあると、説明や学習を進める上で役に立つのではないか

- 補足
    - P2P と言えばこのタイトルだよ、という話をできると理解が早まる
    - 逆に例を挙げられないと説明が大変になる
    - アーケードゲームの博物館のようにオンラインゲームの博物館のようなものがあると良さそう
- 保守の問題
    - P2P であったとしても、ネットワーク事情が変わるので保守をしないと繋がらなくなりそう
- ユースケースとしての教材
    - 暗号化の話同様、フルメッシュはどういうゲームに合う、というようなユースケースがあると良さそう


### 初学者むけの体系的な情報源

(時間が無かったので講演者用意の話の読み上げまで)

- リアルタイム通信の技術書少ない問題
    - 「オンラインゲームを支える技術」以来本格的なものは出版されていない？
        - オンラインゲームを支える技術 もリアルタイム通信にフォーカスしたものではない
    - "コミュニティ"で技術同人誌を書いてみようという話になっている


### C/C++の必要性

(時間が無かったので議論というよりはトピック挙げまで)

- 最近のネットワーク業界的には Rust が強いがゲーム業界的には様々な事情で Rust ではなく C/C++ の方が都合が良い
- 近い将来 AI で変換できるようになるかもしれない
- トラブルや調査時には C/C++ を理解できている方が望ましいケースがある


### 当日議論しなかったお題(講演者用意)

- 若い子にどうやって興味を持って貰うか
    - 仕様の歴史が積み重なり過ぎていて今からやるのは辛い問題
        - これはネットワークに限った話ではない
    - グラフィクス等に比べて地味問題
    - 運用面や地政学等も絡んできて仕様だけ把握してもうまくいかない問題
- そもそも現役の我々も追い切れない問題
    - RFCいつの間にか五桁いきそう問題
    - プラットフォーム別の知識だけでも業務時間使い切る問題(と言うか間に合わない)
    - クラウドサービスの知識だけでも一生追い切れない問題
- みんなで協力していきましょう……！